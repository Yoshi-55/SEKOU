<%= form_with(model: job, class: "space-y-6") do |f| %>
  <% if job.errors.any? %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <p class="font-bold mb-2"><%= pluralize(job.errors.count, "個") %>のエラーがあります:</p>
      <ul class="list-disc list-inside">
        <% job.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- 基本情報 -->
  <div class="border-b pb-6">
    <h2 class="text-xl font-bold mb-4">基本情報</h2>

    <div class="space-y-4">
      <div>
        <%= f.label :group_id, "公開グループ（必須）", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :group_id,
          options_from_collection_for_select(current_user.groups, :id, :name, f.object.group_id),
          { prompt: "グループを選択してください" },
          class: "w-full border border-gray-300 rounded px-4 py-2",
          data: {
            groups: current_user.groups.map { |g|
              {
                id: g.id,
                members: g.members.where.not(id: current_user.id).map { |m| { id: m.id, name: m.name } }
              }
            }.to_json
          } %>
        <p class="text-sm text-gray-500 mt-1">※案件は選択したグループのメンバーのみに公開されます</p>
        <% if current_user.groups.empty? %>
          <p class="text-sm text-red-600 mt-1">※グループに参加する必要があります</p>
        <% end %>
      </div>

      <div id="notification-settings" style="display: none;">
        <%= f.label :notified_member_ids, "通知先メンバー", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <div class="space-y-2 p-3 border border-gray-300 rounded bg-gray-50 max-h-60 overflow-y-auto">
          <label class="flex items-center gap-2 cursor-pointer">
            <%= check_box_tag "notify_all", "1", false, class: "w-5 h-5 rounded border-gray-300", id: "notify_all_checkbox" %>
            <span class="text-base font-medium">グループ全員に通知</span>
          </label>
          <div id="member-checkboxes" class="ml-6 space-y-2">
            <!-- メンバーリストはJavaScriptで動的生成 -->
          </div>
        </div>
        <p class="text-sm text-gray-500 mt-1">※通知先を選択してください。全員に通知する場合は「グループ全員に通知」にチェックを入れてください。</p>
      </div>

      <div>
        <%= f.label :title, "案件タイトル", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :title, class: "w-full border border-gray-300 rounded px-4 py-2", placeholder: "例: カーラッピング施工スタッフ募集" %>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <%= f.label :start_date, "作業開始日", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.date_field :start_date, class: "w-full border border-gray-300 rounded px-4 py-2" %>
        </div>
        <div>
          <%= f.label :end_date, "作業終了日（任意）", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.date_field :end_date, class: "w-full border border-gray-300 rounded px-4 py-2" %>
          <p class="text-sm text-gray-500 mt-1">※複数日の場合のみ入力</p>
        </div>
      </div>

      <div>
        <%= f.label :description, "案件詳細", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_area :description, rows: 8, class: "w-full border border-gray-300 rounded px-4 py-2", placeholder: "案件の詳細を記入してください..." %>
        <p class="text-sm text-gray-500 mt-1">※作業内容、必要な技術、注意事項などを詳しく記入してください</p>
      </div>

      <div class="grid grid-cols-1 gap-4">
        <div>
          <%= f.label :job_type, "案件種別", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :job_type,
            [
              ["カーラッピング施工", "car_wrapping"],
              ["フリート施工", "fleet"],
              ["PPF施工", "ppf"],
              ["その他", "other"]
            ],
            { include_blank: "選択してください" },
            class: "w-full border border-gray-300 rounded px-4 py-2" %>
        </div>

        <div>
          <%= f.label :location, "地域", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :location,
            [
              ["東京都", "東京都"],
              ["神奈川県", "神奈川県"],
              ["埼玉県", "埼玉県"],
              ["千葉県", "千葉県"],
              ["大阪府", "大阪府"],
              ["愛知県", "愛知県"],
              ["福岡県", "福岡県"],
              ["その他", "その他"]
            ],
            { include_blank: "選択してください" },
            class: "w-full border border-gray-300 rounded px-4 py-2" %>
        </div>
      </div>

      <div>
        <%= f.label :address, "詳細住所（任意）", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :address, class: "w-full border border-gray-300 rounded px-4 py-2", placeholder: "例: 渋谷区神南1-1-1" %>
      </div>
    </div>
  </div>

  <!-- 条件 -->
  <div class="border-b pb-6">
    <h2 class="text-xl font-bold mb-4">条件</h2>

    <div class="grid grid-cols-1 gap-4">
      <div>
        <%= f.label :budget, "日当（円）", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.number_field :budget, class: "w-full border border-gray-300 rounded px-4 py-2", placeholder: "25000", min: 5000, step: 5000 %>
        <p class="text-sm text-gray-500 mt-1">※5000円単位で入力してください</p>
      </div>

      <div>
        <%= f.label :required_people, "必要人数", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.number_field :required_people, class: "w-full border border-gray-300 rounded px-4 py-2", value: job.required_people || 1, min: 1 %>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="flex gap-4">
    <%= button_tag "案件を掲載する", type: "submit",
          disabled: current_user.groups.empty?,
          class: "flex-1 px-4 py-2 rounded-lg font-medium text-sm #{ current_user.groups.empty? ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white' }" %>
    <%= link_to "キャンセル", jobs_path, class: "inline-flex items-center px-4 py-2 rounded-lg font-medium text-sm text-gray-700 hover:bg-gray-100" %>
  </div>
<% end %>

<script>
document.addEventListener('turbo:load', function() {
  const groupSelect = document.querySelector('[data-groups]');
  const notificationSettings = document.getElementById('notification-settings');
  const memberCheckboxesContainer = document.getElementById('member-checkboxes');
  const notifyAllCheckbox = document.getElementById('notify_all_checkbox');

  if (!groupSelect) return;

  const groupsData = JSON.parse(groupSelect.dataset.groups || '[]');

  function updateNotificationSettings() {
    const selectedGroupId = parseInt(groupSelect.value);

    if (!selectedGroupId) {
      notificationSettings.style.display = 'none';
      return;
    }

    const selectedGroup = groupsData.find(g => g.id === selectedGroupId);
    if (!selectedGroup) {
      notificationSettings.style.display = 'none';
      return;
    }

    // メンバーチェックボックスを生成
    memberCheckboxesContainer.innerHTML = '';
    selectedGroup.members.forEach(member => {
      const label = document.createElement('label');
      label.className = 'flex items-center gap-2 cursor-pointer';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.name = 'job[notified_member_ids][]';
      checkbox.value = member.id;
      checkbox.className = 'w-5 h-5 rounded border-gray-300 member-checkbox';
      checkbox.disabled = notifyAllCheckbox.checked;

      const span = document.createElement('span');
      span.className = 'text-base';
      span.textContent = member.name;

      label.appendChild(checkbox);
      label.appendChild(span);
      memberCheckboxesContainer.appendChild(label);

      // 個別チェックボックスのイベント
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          notifyAllCheckbox.checked = false;
        }
      });
    });

    notificationSettings.style.display = 'block';
  }

  // グループ選択時
  groupSelect.addEventListener('change', updateNotificationSettings);

  // 全員通知チェックボックス
  if (notifyAllCheckbox) {
    notifyAllCheckbox.addEventListener('change', function() {
      const memberCheckboxes = document.querySelectorAll('.member-checkbox');
      memberCheckboxes.forEach(cb => {
        cb.disabled = this.checked;
        if (this.checked) {
          cb.checked = false;
        }
      });
    });
  }

  // 初回表示時
  updateNotificationSettings();
});
</script>
