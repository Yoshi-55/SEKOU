<% if !user_signed_in? || current_user.groups.empty? %>
  <!-- グループ未所属の場合のメッセージ -->
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-12 text-center">
    <% if !user_signed_in? %>
      <h2 class="text-3xl font-bold mb-4">案件を閲覧するにはログインが必要です</h2>
      <p class="text-gray-600 mb-6">このプラットフォームはグループメンバー限定で案件を共有するサービスです。</p>
      <%= link_to "ログイン", new_user_session_path, class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg inline-block font-medium text-sm mr-2" %>
      <%= link_to "新規登録", new_user_registration_path, class: "bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg inline-block font-medium text-sm" %>
    <% else %>
      <h2 class="text-3xl font-bold mb-4">グループに参加してください</h2>
      <p class="text-gray-600 mb-6">案件を閲覧するには、グループを作成するか、既存のグループに参加する必要があります。</p>
      <%= link_to "グループを作成する", new_group_path, class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg inline-block font-medium text-sm" %>
    <% end %>
  </div>
<% else %>
<div class="max-w-4xl mx-auto">
  <div class="mb-4">
    <h1 class="text-3xl font-bold mb-2">案件一覧</h1>
    <p class="text-gray-600">カーラッピング・フリート施工案件を探す</p>
  </div>

  <!-- Filter and Sort Section -->
  <div class="bg-white rounded-lg shadow p-4 mb-4">
    <%= form_with url: jobs_path, method: :get, class: "space-y-3" do |f| %>
      <div class="grid grid-cols-2 gap-3">
        <!-- Job Type Filter -->
        <div>
          <%= f.label :job_type, "案件種別", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :job_type,
            options_for_select([
              ["すべて", ""],
              ["カーラッピング施工", "car_wrapping"],
              ["フリート施工", "fleet"],
              ["PPF施工", "ppf"],
              ["その他", "other"]
            ], params[:job_type]),
            {},
            class: "w-full border border-gray-300 rounded px-3 py-2 text-sm" %>
        </div>

        <!-- Location Filter -->
        <div>
          <%= f.label :location, "地域", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :location,
            options_for_select([
              ["すべて", ""],
              ["東京都", "東京都"],
              ["神奈川県", "神奈川県"],
              ["埼玉県", "埼玉県"],
              ["千葉県", "千葉県"],
              ["大阪府", "大阪府"],
              ["愛知県", "愛知県"],
              ["福岡県", "福岡県"],
              ["その他", "その他"]
            ], params[:location]),
            {},
            class: "w-full border border-gray-300 rounded px-3 py-2 text-sm" %>
        </div>

        <!-- Sort -->
        <div class="col-span-2">
          <%= f.label :sort, "並び替え", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :sort,
            options_for_select([
              ["新着順", ""],
              ["予算が高い順", "budget_desc"],
              ["予算が低い順", "budget_asc"],
              ["作業日が近い順", "date"]
            ], params[:sort]),
            {},
            class: "w-full border border-gray-300 rounded px-3 py-2 text-sm" %>
        </div>
      </div>

      <!-- Submit Buttons -->
      <div class="flex gap-2">
        <a href="#" onclick="this.closest('form').submit(); return false;" class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">検索</a>
        <%= link_to "クリア", jobs_path, class: "inline-flex items-center bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium text-sm" %>
      </div>
    <% end %>
  </div>

  <!-- Job Listings -->
  <% if @jobs.present? %>
    <div class="space-y-4 mb-6">
      <% @jobs.each do |job| %>
        <%= link_to job_path(job), class: "block" do %>
          <div class="bg-white rounded-xl shadow hover:shadow-lg transition-all border border-gray-100 hover:border-blue-200 p-4">
            <div class="flex-1">
              <!-- Title + Badge -->
              <div class="flex items-start justify-between gap-2 mb-2">
                <h3 class="font-bold text-lg text-gray-900 leading-snug"><%= job.title %></h3>
                <span class="shrink-0 text-xs bg-blue-50 text-blue-700 border border-blue-200 px-2 py-1 rounded-full font-medium"><%= job.job_type_label %></span>
              </div>

              <!-- Description -->
              <p class="text-gray-500 mb-3 text-sm leading-relaxed"><%= truncate(job.description, length: 80) %></p>

              <!-- Divider -->
              <div class="border-t border-gray-100 pt-3">
                <!-- Key Info Row -->
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-600">
                  <span class="flex items-center gap-1">📍 <%= job.location %></span>
                  <span class="flex items-center gap-1 font-bold text-blue-600"><%= number_to_currency(job.budget, unit: "¥", precision: 0) %></span>
                  <span class="flex items-center gap-1">📅 <%= l(job.scheduled_date, format: :short) %></span>
                  <span class="flex items-center gap-1 text-gray-400">👤 <%= job.required_people %>名</span>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- Pagination -->
    <div class="flex justify-center">
      <%= paginate @jobs %>
    </div>
  <% else %>
    <div class="bg-white rounded-lg shadow p-12 text-center">
      <p class="text-gray-500 text-lg mb-4">条件に合う案件が見つかりませんでした</p>
      <%= link_to "フィルターをクリア", jobs_path, class: "text-blue-600 hover:underline" %>
    </div>
  <% end %>
</div>
<% end %>
