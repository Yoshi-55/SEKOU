<div class="max-w-4xl mx-auto">
  <!-- Header card -->
  <div class="bg-white rounded-xl shadow border border-gray-100 p-4 mb-4">
    <div class="flex justify-between items-start gap-3 mb-4">
      <div class="flex-1 min-w-0">
        <div class="flex flex-wrap items-center gap-2 mb-1">
          <span class="text-xs bg-blue-50 text-blue-700 border border-blue-200 px-2 py-0.5 rounded-full font-medium"><%= @job.job_type_label %></span>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 leading-snug"><%= @job.title %></h1>
        <p class="text-xs text-gray-400 mt-1">
          掲載日: <%= l(@job.published_at, format: :short) if @job.published_at %>
          <% if @job.expires_at %>| 期限: <%= l(@job.expires_at, format: :short) %><% end %>
        </p>
      </div>

      <% if user_signed_in? && @job.client == current_user %>
        <div class="flex gap-2 shrink-0">
          <%= link_to "編集", edit_job_path(@job), class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm" %>
          <%= link_to "削除", job_path(@job), data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" }, class: "bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm" %>
        </div>
      <% end %>
    </div>

    <!-- Key Info Grid -->
    <div class="grid grid-cols-2 gap-3 p-4 bg-gray-50 rounded-xl">
      <div>
        <p class="text-xs text-gray-400 mb-0.5">予算</p>
        <p class="font-bold text-sm text-blue-600"><%= number_to_currency(@job.budget, unit: "¥", precision: 0) %></p>
      </div>
      <div>
        <p class="text-xs text-gray-400 mb-0.5">作業予定日</p>
        <p class="font-medium text-sm"><%= l(@job.scheduled_date, format: :long) %></p>
      </div>
      <div>
        <p class="text-xs text-gray-400 mb-0.5">必要人数</p>
        <p class="font-medium text-sm"><%= @job.required_people %>名</p>
      </div>
      <div>
        <p class="text-xs text-gray-400 mb-0.5">場所</p>
        <p class="font-medium text-sm">📍 <%= @job.location %></p>
      </div>
      <% if @job.address.present? %>
        <div class="col-span-2">
          <p class="text-xs text-gray-400 mb-0.5">詳細住所</p>
          <% if user_signed_in? && (@job.client == current_user || @accepted) %>
            <p class="font-medium text-sm"><%= @job.address %></p>
          <% else %>
            <p class="text-xs text-gray-400 italic">応募承認後に表示されます</p>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Description -->
  <div class="bg-white rounded-xl shadow border border-gray-100 p-4 mb-4">
    <h2 class="text-base font-bold mb-3 text-gray-700">案件詳細</h2>
    <div class="prose max-w-none text-sm leading-relaxed text-gray-700">
      <%= simple_format(@job.description) %>
    </div>
  </div>

  <!-- Apply Section -->
  <% if user_signed_in? && @job.client != current_user %>
    <div class="bg-white rounded-xl shadow border border-gray-100 p-4 mb-4">
      <h2 class="text-base font-bold mb-3 text-gray-700">この案件に応募する</h2>
      <% if @job.applies.exists?(craftsman: current_user) %>
        <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-xl">
          <p class="font-medium text-sm">この案件には既に応募済みです</p>
          <%= link_to "応募履歴を見る", applies_path, class: "text-green-700 underline mt-1 inline-block text-xs" %>
        </div>
      <% else %>
        <%= link_to "応募する", new_job_apply_path(@job), class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium inline-block text-sm w-full text-center" %>
      <% end %>
    </div>
  <% elsif !user_signed_in? %>
    <div class="bg-white rounded-xl shadow border border-gray-100 p-4 mb-4">
      <h2 class="text-base font-bold mb-2 text-gray-700">この案件に応募するには</h2>
      <p class="text-sm text-gray-500 mb-3">応募するにはログインまたは新規登録が必要です</p>
      <div class="flex flex-col gap-2">
        <%= link_to "ログイン", new_user_session_path, class: "bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium text-sm text-center" %>
        <%= link_to "新規登録", new_user_registration_path, class: "bg-gray-200 hover:bg-gray-300 text-gray-800 px-5 py-2 rounded-lg font-medium text-sm text-center" %>
      </div>
    </div>
  <% end %>

  <!-- Applications List (for Job Owner) -->
  <% if user_signed_in? && @job.client == current_user && @applies.present? %>
    <div class="bg-white rounded-xl shadow border border-gray-100 p-4 mb-4">
      <h2 class="text-base font-bold mb-3 text-gray-700">応募者一覧 (<%= @applies.count %>件)</h2>
      <div class="space-y-3">
        <% @applies.each do |apply| %>
          <div class="border rounded-xl p-4 <%= apply.accepted? ? 'bg-green-50 border-green-200' : 'border-gray-100' %>">
            <div class="flex justify-between items-start gap-2 mb-2">
              <div class="flex-1 min-w-0">
                <p class="font-bold text-sm"><%= apply.craftsman.name %></p>
                <p class="text-xs text-gray-400 mt-0.5">応募日: <%= l(apply.applied_at, format: :short) %></p>
              </div>
              <div class="shrink-0">
                <% if apply.pending? %>
                  <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-medium">審査中</span>
                <% elsif apply.accepted? %>
                  <span class="bg-green-500 text-white text-xs px-2 py-1 rounded-full font-medium">承認済み</span>
                <% elsif apply.rejected? %>
                  <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full font-medium">不採用</span>
                <% end %>
              </div>
            </div>

            <p class="text-xs text-gray-600 leading-relaxed mb-3"><%= truncate(apply.message, length: 120) %></p>

            <% if apply.pending? %>
              <div class="flex gap-2">
                <%= link_to "承認する", accept_apply_path(apply), data: { turbo_method: :patch }, class: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm" %>
                <%= link_to "不採用", reject_apply_path(apply), data: { turbo_method: :patch, turbo_confirm: "本当に不採用としますか？" }, class: "bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm" %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Back to list -->
  <div class="text-center mt-2">
    <%= link_to "← 案件一覧に戻る", jobs_path, class: "text-blue-600 hover:underline text-sm" %>
  </div>
</div>
